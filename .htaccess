# .htaccess - Apache Security Configuration for khup.org
# Comprehensive security headers and protections

# ===============================================
# 1. HTTPS ENFORCEMENT
# ===============================================
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</IfModule>

# ===============================================
# 2. SECURITY HEADERS
# ===============================================
<IfModule mod_headers.c>
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options "nosniff"
    
    # Prevent clickjacking
    Header always set X-Frame-Options "DENY"
    
    # Enable XSS protection
    Header always set X-XSS-Protection "1; mode=block"
    
    # Strict Transport Security (HSTS) - Force HTTPS for 1 year
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permissions Policy (Feature Policy)
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=(), accelerometer=()"
    
    # Content Security Policy
    Header always set Content-Security-Policy "default-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://stackpath.bootstrapcdn.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; script-src 'self' 'unsafe-inline' https://code.jquery.com https://cdnjs.cloudflare.com https://stackpath.bootstrapcdn.com; media-src 'self'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';"
    
    # Remove server signature
    Header always unset X-Powered-By
    Header always unset Server
</IfModule>

# ===============================================
# 3. DISABLE DIRECTORY BROWSING
# ===============================================
Options -Indexes

# ===============================================
# 4. PROTECT SENSITIVE FILES
# ===============================================
<FilesMatch "\.(git|env|htaccess|htpasswd|ini|log|sh|inc|bak|backup|swp|py|pyc)$">
    Require all denied
</FilesMatch>

# Protect .well-known directory except security.txt
<DirectoryMatch "^.*\.well-known.*$">
    <FilesMatch "^(?!security\.txt$).*$">
        Require all denied
    </FilesMatch>
</DirectoryMatch>

# Block access to hidden files and directories
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

# Protect specific directories
<DirectoryMatch "^.*(archive|\.vscode|\.github).*$">
    Require all denied
</DirectoryMatch>

# ===============================================
# 5. PROTECT PRIVATE FILES
# ===============================================
<FilesMatch "\.(pdf|mp3|mp4|flac|wav)$">
    # Add authentication or IP restrictions here if needed
    # For now, allowing access but can be restricted
</FilesMatch>

# ===============================================
# 6. PREVENT HOTLINKING OF MEDIA FILES
# ===============================================
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?khup\.org [NC]
    RewriteRule \.(jpg|jpeg|png|gif|webp|mp3|mp4|pdf)$ - [F,L]
</IfModule>

# ===============================================
# 7. CACHING AND PERFORMANCE
# ===============================================
<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # CSS and JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # Fonts
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType font/otf "access plus 1 year"
    
    # HTML
    ExpiresByType text/html "access plus 1 hour"
</IfModule>

# ===============================================
# 8. COMPRESSION
# ===============================================
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json application/xml
</IfModule>

# ===============================================
# 9. PREVENT SQL INJECTION AND XSS ATTEMPTS
# ===============================================
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Block suspicious query strings
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*iframe.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} base64_encode.*\(.*\) [NC,OR]
    RewriteCond %{QUERY_STRING} (\.\./|\.\.\\) [OR]
    RewriteCond %{QUERY_STRING} (javascript|vbscript):([^\n]*) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C)([^s]*s)+cript.*(>|%3E) [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# ===============================================
# 10. BLOCK BAD BOTS AND SCRAPERS
# ===============================================
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{HTTP_USER_AGENT} ^.*(bot|crawl|spider|scraper|python|curl|wget|HTTrack|EmailCollector|EmailSiphon|WebBandit|EmailWolf).*$ [NC]
    RewriteCond %{HTTP_USER_AGENT} !^.*(Googlebot|bingbot|DuckDuckBot|Slurp|Baiduspider).*$ [NC]
    RewriteRule ^.*$ - [F,L]
</IfModule>

# ===============================================
# 11. CUSTOM ERROR PAGES (Optional)
# ===============================================
# ErrorDocument 403 /errors/403.html
# ErrorDocument 404 /errors/404.html
# ErrorDocument 500 /errors/500.html
